<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover"
  />
  <title>My Account • Passkeys</title>
  <style>
    :root {
      color-scheme: light dark;
      font-synthesis-weight: none;
    }

    body {
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      margin: 24px;
    }

    header {
      display: flex;
      align-items: baseline;
      gap: 12px;
      margin-bottom: 16px;
    }

    h1 {
      font-size: 20px;
      margin: 0;
    }

    .muted {
      opacity: .7
    }

    .card {
      border: 1px solid #ccc;
      border-radius: 12px;
      padding: 16px;
      max-width: 920px;
    }

    .row {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    button, .btn {
      cursor: pointer;
      border: 1px solid transparent;
      padding: 8px 12px;
      border-radius: 10px;
      background: #0d6efd;
      color: #fff;
      font-weight: 600;
    }

    button.secondary {
      background: transparent;
      color: inherit;
      border-color: #999;
    }

    button.destructive {
      background: #dc3545;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    th, td {
      text-align: left;
      padding: 8px 10px;
      border-bottom: 1px solid #e5e5e5;
      vertical-align: top;
    }

    th {
      font-weight: 700;
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f0f0f0;
      font-size: 12px;
    }

    .hidden {
      display: none;
    }

    a.btn.destructive {
      color: #fff;
      text-decoration: none;
      border-color: #dc3545;
      background: #dc3545;
      padding: 8px 12px;
      border-radius: 10px;
    }

    footer {
      margin-top: 24px;
      opacity: .7
    }
  </style>
</head>
<body>
<header>
  <h1>My Account</h1>
  <span class="muted">Manage your passkeys</span>
</header>

<div id="auth-warning" class="card hidden">
  <p>You’re not logged in. Please <a href="/">go to login</a> and sign in with your passkey.</p>
</div>

<section id="me" class="card hidden">
  <div class="row" style="justify-content: space-between;">
    <div>
      <div class="muted">Signed in as</div>
      <div id="me-email" style="font-weight:600;"></div>
    </div>
    <div class="row">
      <button id="btn-create" title="Create a new passkey for this account">Create new passkey</button>
      <a class="btn destructive" href="/logout" title="Sign out">Sign out</a>
    </div>
  </div>

  <h2 style="margin:18px 0 6px;">Your Passkeys</h2>
  <div class="muted" id="passkey-empty" style="margin-top:6px;">No passkeys yet.</div>
  <table id="passkey-table" class="hidden" aria-label="Stored passkeys">
    <thead>
    <tr>
      <th>Credential</th>
      <th>User ID</th>
      <th>Counter</th>
      <th>Fmt</th>
      <th>AAGUID</th>
      <th>Backed Up</th>
      <th>Multi Device</th>
      <th>Created At</th>
      <th></th>
    </tr>
    </thead>
    <tbody id="passkey-tbody"></tbody>
  </table>
</section>

<footer>
  <small class="muted">Tip: create at least two passkeys (e.g., phone + laptop) for account recovery.</small>
</footer>

<script>
  // ---- Adjust these if your routes differ ----
  const API = {
    me: '/me',
    json: '/me-creds',
    registerOptions: '/webauthn/register/options',
    registerVerify: '/webauthn/register/verify',
    deleteCredential: (id) => `/webauthn/credentials/${encodeURIComponent(id)}`,
  };

  const fromB64Url = (s) => {
    s = s.replace(/-/g, '+').replace(/_/g, '/');
    const pad = s.length % 4 ? 4 - (s.length % 4) : 0;
    const bin = atob(s + '='.repeat(pad));
    const bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
    return bytes.buffer;
  };

  const toB64Url = (buf) => {
    const b = Array.from(new Uint8Array(buf), x => String.fromCharCode(x)).join('');
    return btoa(b).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  };

  function formatDate(ts) {
    if (!ts) return '';
    try {
      const d = new Date(ts);
      if (isNaN(d.getTime())) return String(ts);
      return d.toLocaleString();
    } catch {
      return String(ts);
    }
  }

  function shortId(id) {
    if (!id) return '';
    const s = String(id);
    return s.length <= 12 ? s : `${s.slice(0, 6)}…${s.slice(-6)}`;
  }

  // ---- DOM refs ----
  const elAuthWarn = document.getElementById('auth-warning');
  const elMe = document.getElementById('me');
  const elEmail = document.getElementById('me-email');
  const elEmpty = document.getElementById('passkey-empty');
  const elTable = document.getElementById('passkey-table');
  const elTBody = document.getElementById('passkey-tbody');
  const btnCreate = document.getElementById('btn-create');

  // ---- State ----
  let ME = null;

  // ---- Load session + passkeys ----
  init().catch(err => {
    console.error(err);
    alert('Error loading account: ' + (err?.message || err));
  });

  async function init() {
    const res = await fetch(API.json, {
      credentials: 'include',
      headers: {'Accept': 'application/json'},
    });

    if (res.status === 401 || res.status === 403) {
      elAuthWarn.classList.remove('hidden');
      return;
    }

    if (!res.ok) throw new Error('Failed to fetch ' + API.json);
    ME = await res.json();

    elMe.classList.remove('hidden');
    elEmail.textContent = ME.email || '(unknown email)';

    renderCredentials(Array.isArray(ME.credentials) ? ME.credentials : []);
  }

  function renderCredentials(list) {
    elTBody.innerHTML = '';
    if (!list.length) {
      elEmpty.classList.remove('hidden');
      elTable.classList.add('hidden');
      return;
    }
    elEmpty.classList.add('hidden');
    elTable.classList.remove('hidden');

    list.forEach(cred => {
      const tr = document.createElement('tr');

      const tdId = document.createElement('td');
      tdId.innerHTML = `<code title="${cred.id || ''}">${shortId(cred.id)}</code>`;
      tr.appendChild(tdId);

      const tdUserId = document.createElement('td');
      tdUserId.innerHTML = `<code title="${cred.user_id || ''}">${shortId(cred.user_id)}</code>`;
      tr.appendChild(tdUserId);

      const tdCounter = document.createElement('td');
      tdCounter.textContent = cred.counter.toString() || '';
      tr.appendChild(tdCounter);

      const tdFmt = document.createElement('td');
      tdFmt.textContent = cred.fmt || '';
      tr.appendChild(tdFmt);

      const tdAaguid = document.createElement('td');
      tdAaguid.textContent = cred.aaguid || '';
      tr.appendChild(tdAaguid);

      const tdBackedUp = document.createElement('td');
      tdBackedUp.textContent = cred.backed_up ? 'Yes' : 'No';
      tr.appendChild(tdBackedUp);

      const tdUv = document.createElement('td');
      tdUv.textContent = cred.multi_device ? 'Yes' : 'No';
      tr.appendChild(tdUv);

      const tdCreated = document.createElement('td');
      tdCreated.textContent = formatDate(cred.created_at);
      tr.appendChild(tdCreated);

      const tdActions = document.createElement('td');
      const del = document.createElement('button');
      del.className = 'destructive';
      del.textContent = 'Remove';
      del.title = 'Remove this passkey from your account';
      del.addEventListener('click', () => deleteCredential(cred));
      tdActions.appendChild(del);
      tr.appendChild(tdActions);

      elTBody.appendChild(tr);
    });
  }

  // ---- Create a new passkey flow (WebAuthn registration) ----
  btnCreate.addEventListener('click', async () => {
    try {
      if (!window.PublicKeyCredential) {
        alert('WebAuthn is not supported in this browser.');
        return;
      }

      btnCreate.disabled = true;

      // 1) Get creation options from server (already tied to logged-in user)
      const res = await fetch(API.registerOptions, {
        method: 'POST',
        headers: {'content-type': 'application/json'},
        credentials: 'include',
        body: JSON.stringify({email: ME.email}) // session identifies user
      });
      if (!res.ok) throw new Error('Failed to fetch register options');
      const opts = await res.json();

      // Convert challenge & user.id to buffers
      opts.challenge = fromB64Url(opts.challenge);
      if (opts.user && opts.user.id) opts.user.id = new TextEncoder().encode(opts.user.id);

      // 2) Create credential with the platform authenticator
      const cred = await navigator.credentials.create({publicKey: opts});
      if (!cred) throw new Error('Creation was cancelled or failed');

      // 3) Build payload for verify endpoint
      const attResp = {
        id: cred.id,
        rawId: toB64Url(cred.rawId),
        type: cred.type,
        response: {
          clientDataJSON: toB64Url(cred.response.clientDataJSON),
          attestationObject: toB64Url(cred.response.attestationObject),
          transports: cred.response.getTransports ? cred.response.getTransports() : undefined,
        }
      };

      // 4) Verify & store on server
      const verify = await fetch(API.registerVerify, {
        method: 'POST',
        headers: {'content-type': 'application/json'},
        body: JSON.stringify({email: ME.email, attResp}),
      });
      if (!verify.ok) {
        const txt = await verify.text().catch(() => '');
        throw new Error('Register verify failed: ' + txt);
      }

      // 5) Refresh the list
      await init();
      btnCreate.disabled = false;
      alert('New passkey created!');
    } catch (err) {
      btnCreate.disabled = false;
      console.error(err);
      alert('Could not create passkey: ' + (err?.message || err));
    }
  });

  // ---- Delete credential ----
  async function deleteCredential(cred) {
    if (!cred?.id) return;
    const yes = confirm('Remove this passkey?\n\n' + cred.id);
    if (!yes) return;

    const res = await fetch(API.deleteCredential(cred.id), {
      method: 'DELETE',
      credentials: 'include',
    });
    if (!res.ok) {
      const txt = await res.text().catch(() => '');
      alert('Failed to remove: ' + txt);
      return;
    }
    // Optimistic update or full reload
    const next = (ME.credentials || []).filter(c => c.id !== cred.id);
    ME.credentials = next;
    renderCredentials(next);
  }
</script>
</body>
</html>

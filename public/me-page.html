<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover"
  />
  <title>My Account • Passkeys</title>
  <style>
    :root {
      color-scheme: light dark;
      font-synthesis-weight: none;
    }

    body {
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      margin: 24px;
    }

    header {
      display: flex;
      align-items: baseline;
      gap: 12px;
      margin-bottom: 16px;
    }

    h1 {
      font-size: 20px;
      margin: 0;
    }

    .muted {
      opacity: .7
    }

    .card {
      border: 1px solid #ccc;
      border-radius: 12px;
      padding: 16px;
      max-width: 920px;
    }

    .row {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    button, .btn {
      cursor: pointer;
      border: 1px solid transparent;
      padding: 8px 12px;
      border-radius: 10px;
      background: #0d6efd;
      color: #fff;
      font-weight: 600;
    }

    button.secondary {
      background: transparent;
      color: inherit;
      border-color: #999;
    }

    button.destructive {
      background: #dc3545;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    th, td {
      text-align: left;
      padding: 8px 10px;
      border-bottom: 1px solid #e5e5e5;
      vertical-align: top;
    }

    th {
      font-weight: 700;
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f0f0f0;
      font-size: 12px;
    }

    .hidden {
      display: none;
    }

    footer {
      margin-top: 24px;
      opacity: .7
    }
  </style>
</head>
<body>
<header>
  <h1>My Account</h1>
  <span class="muted">Manage your passkeys</span>
</header>

<div id="auth-warning" class="card hidden">
  <p>You’re not logged in. Please <a href="/">go to login</a> and sign in with your passkey.</p>
</div>

<section id="me" class="card hidden">
  <div class="row" style="justify-content: space-between;">
    <div>
      <div class="muted">Signed in as</div>
      <div id="me-email" style="font-weight:600;"></div>
    </div>
    <div class="row">
      <button id="btn-create" title="Create a new passkey for this account">Create new passkey</button>
      <a class="btn secondary" href="/" title="Back to Home">Home</a>
    </div>
    <div class="row">
      <a class="btn destructive" href="/logout" title="Sign out">Sign out</a>
    </div>
  </div>

  <h2 style="margin:18px 0 6px;">Your Passkeys</h2>
  <div class="muted" id="passkey-empty" style="margin-top:6px;">No passkeys yet.</div>
  <table id="passkey-table" class="hidden" aria-label="Stored passkeys">
    <thead>
    <tr>
      <th>Credential ID</th>
      <th>User ID</th>
      <th>Counter</th>
      <th>Fmt</th>
      <th>AAGUID</th>
      <th>Backed Up</th>
      <th>UV</th>
      <th>Created At</th>
    </tr>
    </thead>
    <tbody id="passkey-tbody"></tbody>
  </table>
</section>

<footer>
  <small class="muted">Tip: create at least two passkeys (e.g., phone + laptop) for account recovery.</small>
</footer>

<script>
  // ---- Adjust these if your routes differ ----
  const API = {
    me: '/me',
    json: '/me-creds',
    registerOptions: '/webauthn/register/options',
    registerVerify: '/webauthn/register/verify',
    deleteCredential: (id) => `/webauthn/credentials/${encodeURIComponent(id)}`,
  };

  // ---- Small utils ----
  const enc = new TextEncoder();
  const dec = new TextDecoder();

  // Base64URL helpers (ArrayBuffer <-> string)
  function b64urlToBuf(b64url) {
    const pad = '='.repeat((4 - (b64url.length % 4)) % 4);
    const b64 = (b64url.replace(/-/g, '+').replace(/_/g, '/')) + pad;
    const str = atob(b64);
    const buf = new ArrayBuffer(str.length);
    const bytes = new Uint8Array(buf);
    for (let i = 0; i < str.length; i++) bytes[i] = str.charCodeAt(i);
    return buf;
  }

  function bufToB64url(buf) {
    const bytes = new Uint8Array(buf);
    let str = '';
    for (let i = 0; i < bytes.length; i++) str += String.fromCharCode(bytes[i]);
    const b64 = btoa(str);
    return b64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }

  function formatDate(ts) {
    if (!ts) return '';
    try {
      const d = new Date(ts);
      if (isNaN(d.getTime())) return String(ts);
      return d.toLocaleString();
    } catch {
      return String(ts);
    }
  }

  function shortId(id) {
    if (!id) return '';
    const s = String(id);
    return s.length <= 12 ? s : `${s.slice(0, 6)}…${s.slice(-6)}`;
  }

  // ---- DOM refs ----
  const elAuthWarn = document.getElementById('auth-warning');
  const elMe = document.getElementById('me');
  const elEmail = document.getElementById('me-email');
  const elEmpty = document.getElementById('passkey-empty');
  const elTable = document.getElementById('passkey-table');
  const elTBody = document.getElementById('passkey-tbody');
  const btnCreate = document.getElementById('btn-create');

  // ---- State ----
  let ME = null;

  // ---- Load session + passkeys ----
  init().catch(err => {
    console.error(err);
    alert('Error loading account: ' + (err?.message || err));
  });

  async function init() {
    const res = await fetch(API.json, {
      credentials: 'include',
      headers: {'Accept': 'application/json'},
    });

    if (res.status === 401 || res.status === 403) {
      elAuthWarn.classList.remove('hidden');
      return;
    }

    if (!res.ok) throw new Error('Failed to fetch ' + API.json);
    ME = await res.json();

    elMe.classList.remove('hidden');
    elEmail.textContent = ME.email || '(unknown email)';

    renderCredentials(Array.isArray(ME.credentials) ? ME.credentials : []);
  }

  function renderCredentials(list) {
    elTBody.innerHTML = '';
    if (!list.length) {
      elEmpty.classList.remove('hidden');
      elTable.classList.add('hidden');
      return;
    }
    elEmpty.classList.add('hidden');
    elTable.classList.remove('hidden');

    list.forEach(cred => {
      const tr = document.createElement('tr');

      const tdId = document.createElement('td');
      tdId.innerHTML = `<code title="${cred.id || ''}">${shortId(cred.id)}</code>`;
      tr.appendChild(tdId);

      const tdUserId = document.createElement('td');
      tdId.innerHTML = `<div class="muted">UserID: <code>${cred.user_id}</code></div>`;
      tr.appendChild(tdUserId);

      const tdCounter = document.createElement('td');
      tdId.innerHTML = `<div class="muted">Counter: <code>${cred.counter}</code></div>`;
      tr.appendChild(tdCounter);

      const tdFmt = document.createElement('td');
      tdId.innerHTML = `<div class="muted">Fmt: <code>${cred.fmt}</code></div>`;
      tr.appendChild(tdFmt);

      const tdAaguid = document.createElement('td');
      tdId.innerHTML = `<div class="muted">AAGUID: <code>${cred.aaguid}</code></div>`;
      tr.appendChild(tdAaguid);

      const tdBackedUp = document.createElement('td');
      tdId.innerHTML = `<div class="muted">Fmt: <code>${cred.backed_up}</code></div>`;
      tr.appendChild(tdBackedUp);

      const tdUv = document.createElement('td');
      tdId.innerHTML = `<div class="muted">Uv: <code>${cred.uv}</code></div>`;
      tr.appendChild(tdUv);

      const tdCreated = document.createElement('td');
      tdCreated.textContent = formatDate(cred.created_at);
      tr.appendChild(tdCreated);

      const tdActions = document.createElement('td');
      const del = document.createElement('button');
      del.className = 'destructive';
      del.textContent = 'Remove';
      del.title = 'Remove this passkey from your account';
      del.addEventListener('click', () => deleteCredential(cred));
      tdActions.appendChild(del);
      tr.appendChild(tdActions);

      elTBody.appendChild(tr);
    });
  }

  // ---- Create a new passkey flow (WebAuthn registration) ----
  btnCreate.addEventListener('click', async () => {
    try {
      if (!window.PublicKeyCredential) {
        alert('WebAuthn is not supported in this browser.');
        return;
      }

      // 1) Get creation options from server (already tied to logged-in user)
      const res = await fetch(API.registerOptions, {
        method: 'POST',
        headers: {'content-type': 'application/json'},
        credentials: 'include',
        body: JSON.stringify({email: ME.email}) // session identifies user
      });
      if (!res.ok) throw new Error('Failed to fetch register options');
      const opts = await res.json();

      // Convert base64url strings to ArrayBuffers where required
      opts.challenge = b64urlToBuf(opts.challenge);
      if (opts.user && typeof opts.user.id === 'string') {
        opts.user.id = b64urlToBuf(opts.user.id);
      }
      if (Array.isArray(opts.excludeCredentials)) {
        opts.excludeCredentials = opts.excludeCredentials.map(c => ({
          ...c,
          id: typeof c.id === 'string' ? b64urlToBuf(c.id) : c.id
        }));
      }

      // 2) Create credential with the platform authenticator
      const cred = await navigator.credentials.create({publicKey: opts});
      if (!cred) throw new Error('Creation was cancelled or failed');

      // 3) Build payload for verify endpoint
      const attResp = {
        id: cred.id,
        rawId: bufToB64url(cred.rawId),
        type: cred.type,
        response: {
          clientDataJSON: bufToB64url(cred.response.clientDataJSON),
          attestationObject: bufToB64url(cred.response.attestationObject),
          transports: cred.response.getTransports ? cred.response.getTransports() : undefined,
        }
      };

      // 4) Verify & store on server
      const verify = await fetch(API.registerVerify, {
        method: 'POST',
        headers: {'content-type': 'application/json'},
        body: JSON.stringify({email: ME.email, attResp}),
      });
      if (!verify.ok) {
        const txt = await verify.text().catch(() => '');
        throw new Error('Register verify failed: ' + txt);
      }

      // 5) Refresh the list
      await init();
      alert('New passkey created!');
    } catch (err) {
      console.error(err);
      alert('Could not create passkey: ' + (err?.message || err));
    }
  });

  // ---- Delete credential ----
  async function deleteCredential(cred) {
    if (!cred?.id) return;
    const yes = confirm('Remove this passkey?\n\n' + cred.id);
    if (!yes) return;

    const res = await fetch(API.deleteCredential(cred.id), {
      method: 'DELETE',
      credentials: 'include',
    });
    if (!res.ok) {
      const txt = await res.text().catch(() => '');
      alert('Failed to remove: ' + txt);
      return;
    }
    // Optimistic update or full reload
    const next = (ME.credentials || []).filter(c => c.id !== cred.id);
    ME.credentials = next;
    renderCredentials(next);
  }
</script>
</body>
</html>
